<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>合成音声コーパス作成支援アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .record-btn.recording .fa-microphone {
            display: none;
        }
        .record-btn:not(.recording) .fa-stop {
            display: none;
        }
        .record-btn.recording {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-2xl mx-auto p-6 md:p-8 bg-white rounded-2xl shadow-lg">
        
        <!-- 初期画面 -->
        <div id="initial-screen">
            <h1 class="text-3xl font-bold text-center mb-4">コーパス作成支援アプリ</h1>
            <p class="text-gray-600 text-center mb-8">読み上げる台本のセットを選択してください。</p>
            <div class="flex flex-col items-center">
                <select id="script-select" class="w-full max-w-xs p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <!-- Options will be populated by JS -->
                </select>
                <button id="start-btn" class="mt-6 w-full max-w-xs bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    開始
                </button>
            </div>
        </div>

        <!-- 録音画面 -->
        <div id="recording-screen" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 id="script-title" class="text-xl font-bold"></h2>
                <span id="progress-indicator" class="text-sm font-semibold text-gray-500 bg-gray-200 px-3 py-1 rounded-full"></span>
            </div>
            
            <div id="text-display" class="bg-gray-50 p-8 rounded-lg text-center text-3xl font-semibold my-6 border border-gray-200 min-h-[150px] flex items-center justify-center">
                <!-- Text will be displayed here -->
            </div>
            
            <div class="flex flex-col items-center space-y-5">
                <div class="flex items-center space-x-4">
                    <button id="record-btn" class="record-btn w-20 h-20 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center text-3xl shadow-lg transition-transform transform hover:scale-110 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
                        <i class="fas fa-microphone"></i>
                        <i class="fas fa-stop"></i>
                    </button>
                    <p id="status-text" class="text-gray-600 font-medium w-32 text-center">録音ボタンを押してください</p>
                </div>
                
                <div id="audio-playback-area" class="w-full max-w-md hidden">
                     <audio id="audio-player" controls class="w-full"></audio>
                </div>

                <button id="next-btn" class="w-full max-w-md bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    決定して次へ (Enter)
                </button>
                 <button id="rerecord-btn" class="hidden w-full max-w-md bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    もう一度録音する
                </button>
            </div>
        </div>

        <!-- 完了画面 -->
        <div id="completion-screen" class="hidden text-center">
            <h1 class="text-3xl font-bold mb-4">お疲れ様でした！</h1>
            <p class="text-gray-600 mb-8">すべての文章の録音が完了しました。下のボタンからデータをダウンロードしてください。</p>
            <div id="download-spinner" class="hidden my-4">
                 <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                 <p class="mt-2 text-sm text-gray-500">Zipファイルを生成中です...</p>
            </div>
            <button id="download-btn" class="w-full max-w-xs bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                音声とテキストをダウンロード
            </button>
             <button id="restart-btn" class="mt-4 w-full max-w-xs bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                最初からやり直す
            </button>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM要素 ---
            const initialScreen = document.getElementById('initial-screen');
            const recordingScreen = document.getElementById('recording-screen');
            const completionScreen = document.getElementById('completion-screen');
            
            const scriptSelect = document.getElementById('script-select');
            const startBtn = document.getElementById('start-btn');
            
            const scriptTitle = document.getElementById('script-title');
            const progressIndicator = document.getElementById('progress-indicator');
            const textDisplay = document.getElementById('text-display');
            const recordBtn = document.getElementById('record-btn');
            const statusText = document.getElementById('status-text');
            const audioPlaybackArea = document.getElementById('audio-playback-area');
            const audioPlayer = document.getElementById('audio-player');
            const nextBtn = document.getElementById('next-btn');
            const rerecordBtn = document.getElementById('rerecord-btn');

            const downloadBtn = document.getElementById('download-btn');
            const downloadSpinner = document.getElementById('download-spinner');
            const restartBtn = document.getElementById('restart-btn');

            // --- 台本データ ---
            const scripts = {
                "basic_set": {
                    name: "基本セット (10文)",
                    lines: [
                        "おはようございます。",
                        "こんにちは。",
                        "こんばんは。",
                        "ありがとうございます。",
                        "どういたしまして。",
                        "すみません。",
                        "ごめんなさい。",
                        "お疲れ様です。",
                        "失礼します。",
                        "よろしくお願いします。"
                    ]
                },
                "emotion_set": {
                    name: "感情表現セット (8文)",
                    lines: [
                        "とても嬉しいです。",
                        "本当に悲しいです。",
                        "びっくりしました。",
                        "すごく怒っています。",
                        "楽しかったです。",
                        "不安でいっぱいです。",
                        "それは面白いですね。",
                        "つまらないです。"
                    ]
                }
            };

            // --- 状態管理 ---
            let mediaRecorder;
            let audioChunks = [];
            let recordedData = []; // { filename, blob, text }
            let currentScriptKey;
            let currentScript;
            let currentIndex = 0;
            let isRecording = false;
            let currentBlob = null;
            let stream;

            // --- 初期化処理 ---

            // 台本選択肢を生成
            Object.keys(scripts).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = scripts[key].name;
                scriptSelect.appendChild(option);
            });
            
            // --- イベントリスナー ---
            
            startBtn.addEventListener('click', startRecordingSession);
            recordBtn.addEventListener('click', toggleRecording);
            nextBtn.addEventListener('click', goToNextLine);
            rerecordBtn.addEventListener('click', setupForRerecording);
            downloadBtn.addEventListener('click', createAndDownloadZip);
            restartBtn.addEventListener('click', () => location.reload());

            // Enterキーで次へ進む
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !nextBtn.disabled && recordingScreen.style.display !== 'none') {
                    e.preventDefault();
                    goToNextLine();
                }
            });

            // --- 機能 ---

            async function startRecordingSession() {
                try {
                    // マイクへのアクセス許可
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    currentScriptKey = scriptSelect.value;
                    currentScript = scripts[currentScriptKey];
                    
                    initialScreen.style.display = 'none';
                    recordingScreen.style.display = 'block';
                    
                    scriptTitle.textContent = currentScript.name;
                    currentIndex = 0;
                    recordedData = [];
                    isRecording = false;
                    
                    updateDisplay();
                    resetRecordingState();

                } catch (err) {
                    console.error("マイクへのアクセスが拒否されました:", err);
                    alert("マイクへのアクセスが必要です。ブラウザの設定を確認して、マイクの使用を許可してください。");
                }
            }
            
            function updateDisplay() {
                if (currentIndex < currentScript.lines.length) {
                    textDisplay.textContent = currentScript.lines[currentIndex];
                    progressIndicator.textContent = `${currentIndex + 1} / ${currentScript.lines.length}`;
                } else {
                    // 全て完了
                    recordingScreen.style.display = 'none';
                    completionScreen.style.display = 'block';
                    if (stream) {
                       stream.getTracks().forEach(track => track.stop());
                    }
                }
            }

            function resetRecordingState() {
                recordBtn.disabled = false;
                nextBtn.disabled = true;
                rerecordBtn.style.display = 'none';
                audioPlaybackArea.style.display = 'none';
                statusText.textContent = "録音ボタンを押してください";
                currentBlob = null;
                audioChunks = [];
            }
            
            function toggleRecording() {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            }

            function startRecording() {
                if (!stream) {
                     alert("マイクのストリームが利用できません。");
                     return;
                }
                isRecording = true;
                recordBtn.classList.add('recording');
                statusText.textContent = "録音中...";
                
                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });
                mediaRecorder.addEventListener("stop", handleRecordingStop);
                mediaRecorder.start();
            }

            function stopRecording() {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.classList.remove('recording');
                statusText.textContent = "録音完了";
            }
            
            function handleRecordingStop() {
                currentBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(currentBlob);
                audioPlayer.src = audioUrl;
                
                audioPlaybackArea.style.display = 'block';
                recordBtn.disabled = true;
                nextBtn.disabled = false;
                rerecordBtn.style.display = 'block';
                statusText.textContent = "音声を確認してください";
                nextBtn.focus(); // Enterキーが効くようにフォーカス
            }
            
            function goToNextLine() {
                if (!currentBlob) return;
                
                const filename = `${String(currentIndex + 1).padStart(3, '0')}.wav`;
                recordedData.push({
                    filename: filename,
                    blob: currentBlob,
                    text: currentScript.lines[currentIndex]
                });
                
                currentIndex++;
                updateDisplay();
                if(currentIndex < currentScript.lines.length) {
                    resetRecordingState();
                }
            }
            
            function setupForRerecording() {
                resetRecordingState();
                statusText.textContent = "再度録音してください";
            }

            async function createAndDownloadZip() {
                downloadBtn.disabled = true;
                downloadSpinner.style.display = 'block';

                try {
                    const zip = new JSZip();
                    const folderName = currentScriptKey;
                    const folder = zip.folder(folderName);
                    
                    let transcript = '';
                    
                    recordedData.forEach(data => {
                        folder.file(data.filename, data.blob);
                        transcript += `${data.filename}|${data.text}\n`;
                    });

                    folder.file('transcript.txt', transcript);

                    const content = await zip.generateAsync({ type: 'blob' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `${folderName}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                } catch(e) {
                    console.error("ZIPファイルの生成に失敗しました:", e);
                    alert("ZIPファイルの生成に失敗しました。");
                } finally {
                    downloadBtn.disabled = false;
                    downloadSpinner.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>
